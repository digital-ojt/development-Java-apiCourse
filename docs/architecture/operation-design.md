# 運用設計書

## 📋 文書概要

| 項目       | 内容                                |
| ---------- | ----------------------------------- |
| 文書名     | ドローン在庫管理システム 運用設計書 |
| 作成日     | 2024 年 12 月 15 日                 |
| 最終更新日 | 2024 年 12 月 15 日                 |
| バージョン | 1.0.0                               |
| 作成者     | Development Team                    |
| 承認者     | Operation Manager                   |

## 🎯 対象読者

- システム運用チーム
- インフラエンジニア
- システム管理者
- サポートエンジニア
- 開発チーム

---

## 1. 運用方針

### 1.1 運用基本方針

#### 1.1.1 可用性目標

- **稼働率**: 99.5%以上（年間）
- **営業時間内稼働率**: 99.9%以上（平日 8:00-18:00）
- **最大連続ダウンタイム**: 4 時間以内

#### 1.1.2 運用原則

- **予防保守優先**: 障害対応より予防保守を重視
- **自動化推進**: 手動作業の最小化とミス防止
- **監視・アラート**: 24 時間 365 日の監視体制
- **ドキュメント管理**: 運用手順書の継続的更新

### 1.2 運用体制

#### 1.2.1 役割分担

| 役割                       | 担当者             | 責任範囲                       |
| -------------------------- | ------------------ | ------------------------------ |
| **システム管理者**         | インフラチーム     | サーバー・DB・ネットワーク管理 |
| **アプリケーション管理者** | 開発チーム         | アプリケーション・API 管理     |
| **運用オペレーター**       | 運用チーム         | 日常監視・一次対応             |
| **セキュリティ管理者**     | セキュリティチーム | セキュリティ監視・対策         |

#### 1.2.2 勤務体制

- **平日営業時間**: 8:00-18:00（常駐監視）
- **夜間・休日**: オンコール体制（アラート対応）
- **緊急時**: 30 分以内に担当者招集

---

## 2. システム監視

### 2.1 監視対象・項目

#### 2.1.1 インフラ監視

| 監視項目                | 監視間隔 | 警告閾値 | 危険閾値 | 対応レベル        |
| ----------------------- | -------- | -------- | -------- | ----------------- |
| **CPU 使用率**          | 5 分     | 70%      | 85%      | Level 2 / Level 1 |
| **メモリ使用率**        | 5 分     | 80%      | 90%      | Level 2 / Level 1 |
| **ディスク使用率**      | 10 分    | 80%      | 90%      | Level 2 / Level 1 |
| **ディスク I/O 待機率** | 5 分     | 70%      | 85%      | Level 2 / Level 1 |
| **ネットワーク使用率**  | 5 分     | 80%      | 90%      | Level 2 / Level 1 |

#### 2.1.2 アプリケーション監視

| 監視項目             | 監視間隔 | 警告閾値 | 危険閾値     | 対応レベル        |
| -------------------- | -------- | -------- | ------------ | ----------------- |
| **プロセス稼働状況** | 1 分     | -        | プロセス停止 | Level 1           |
| **HTTP 応答時間**    | 1 分     | 3 秒     | 5 秒         | Level 2 / Level 1 |
| **API 応答時間**     | 1 分     | 2 秒     | 3 秒         | Level 2 / Level 1 |
| **エラー率**         | 5 分     | 5%       | 10%          | Level 2 / Level 1 |
| **同時接続数**       | 1 分     | 40 接続  | 45 接続      | Level 2 / Level 1 |

#### 2.1.3 データベース監視

| 監視項目                 | 監視間隔 | 警告閾値 | 危険閾値 | 対応レベル        |
| ------------------------ | -------- | -------- | -------- | ----------------- |
| **データベース接続数**   | 1 分     | 15 接続  | 18 接続  | Level 2 / Level 1 |
| **クエリ実行時間**       | 5 分     | 2 秒     | 5 秒     | Level 2 / Level 1 |
| **スロークエリ数**       | 10 分    | 10 件/時 | 50 件/時 | Level 2 / Level 1 |
| **レプリケーション遅延** | 1 分     | 30 秒    | 60 秒    | Level 2 / Level 1 |
| **デッドロック発生数**   | 10 分    | 5 件/時  | 20 件/時 | Level 2 / Level 1 |

### 2.2 監視ツール・設定

#### 2.2.1 使用監視ツール

- **Zabbix**: サーバー・ネットワーク監視
- **Prometheus + Grafana**: アプリケーション監視
- **Spring Boot Actuator**: ヘルスチェック・メトリクス
- **MySQL Enterprise Monitor**: データベース監視

#### 2.2.2 ヘルスチェックエンドポイント

```http
GET /actuator/health
GET /actuator/metrics
GET /actuator/prometheus
```

#### 2.2.3 監視ダッシュボード構成

```
┌─────────────────────────────────────────┐
│          システム全体ダッシュボード          │
├─────────────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────────────┐ │
│ │ インフラ監視  │ │  アプリケーション監視  │ │
│ │             │ │                   │ │
│ │・CPU/メモリ  │ │・レスポンス時間       │ │
│ │・ディスク    │ │・エラー率            │ │
│ │・ネットワーク │ │・スループット        │ │
│ └─────────────┘ └─────────────────────┘ │
│ ┌─────────────┐ ┌─────────────────────┐ │
│ │ データベース  │ │   ビジネス監視      │ │
│ │             │ │                   │ │
│ │・接続数      │ │・在庫アラート件数    │ │
│ │・クエリ性能   │ │・API呼び出し状況    │ │
│ │・レプリ遅延   │ │・ユーザーアクセス   │ │
│ └─────────────┘ └─────────────────────┘ │
└─────────────────────────────────────────┘
```

### 2.3 アラート設定

#### 2.3.1 アラート通知方法

- **Level 1（緊急）**: 電話 + メール + Slack
- **Level 2（警告）**: メール + Slack
- **Level 3（情報）**: Slack のみ

#### 2.3.2 エスカレーション手順

```
障害発生
    ↓
5分以内: 自動アラート発報
    ↓
15分以内: 一次担当者対応開始
    ↓
30分以内: 対応状況報告・エスカレーション判断
    ↓
60分以内: 二次担当者（管理者）招集
    ↓
2時間以内: 経営層報告（重大障害の場合）
```

---

## 3. ログ管理

### 3.1 ログ種別・保存方針

#### 3.1.1 アプリケーションログ

| ログ種別             | ログレベル | 保存期間 | 格納場所                    | ローテーション |
| -------------------- | ---------- | -------- | --------------------------- | -------------- |
| **アプリケーション** | INFO 以上  | 30 日    | `/var/log/drone-api/`       | 日次           |
| **アクセス**         | -          | 90 日    | `/var/log/nginx/`           | 日次           |
| **エラー**           | ERROR 以上 | 90 日    | `/var/log/drone-api/error/` | 週次           |
| **セキュリティ**     | WARN 以上  | 180 日   | `/var/log/security/`        | 月次           |

#### 3.1.2 データベースログ

```sql
-- MySQL設定例
[mysqld]
# エラーログ
log-error=/var/log/mysql/error.log

# スロークエリログ
slow_query_log=1
slow_query_log_file=/var/log/mysql/slow.log
long_query_time=2

# バイナリログ
log-bin=/var/log/mysql/mysql-bin
expire_logs_days=7
```

### 3.2 ログ分析・監視

#### 3.2.1 ログ集約システム

```
Application Servers
    ↓ (Filebeat)
Elasticsearch Cluster
    ↓
Kibana Dashboard
    ↓
Alert Manager
```

#### 3.2.2 重要ログパターン

| パターン               | 説明                   | アラート条件   |
| ---------------------- | ---------------------- | -------------- |
| `ERROR.*SQLException`  | データベース接続エラー | 10 件/10 分    |
| `WARN.*JWT.*expired`   | 認証トークン期限切れ   | 100 件/時間    |
| `ERROR.*StockShortage` | 在庫不足エラー         | 即座にアラート |
| `ERROR.*Http500`       | システム内部エラー     | 5 件/10 分     |

---

## 4. バックアップ・復旧

### 4.1 バックアップ戦略

#### 4.1.1 データバックアップスケジュール

| バックアップ種別     | 実行時間     | 頻度     | 保存期間 | 保存場所       |
| -------------------- | ------------ | -------- | -------- | -------------- |
| **フルバックアップ** | 03:00        | 日次     | 30 日    | NFS + S3       |
| **増分バックアップ** | 毎時 00 分   | 1 時間毎 | 7 日     | NFS            |
| **設定ファイル**     | 02:00        | 日次     | 90 日    | Git Repository |
| **バイナリログ**     | リアルタイム | 継続     | 7 日     | ローカル + NFS |

#### 4.1.2 バックアップスクリプト例

```bash
#!/bin/bash
# データベースバックアップスクリプト

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
DB_NAME="drone_inventory"

# フルバックアップ実行
mysqldump --single-transaction --routines --triggers \
    --user=${DB_USER} --password=${DB_PASS} \
    ${DB_NAME} | gzip > ${BACKUP_DIR}/full_${DATE}.sql.gz

# S3へのアップロード
aws s3 cp ${BACKUP_DIR}/full_${DATE}.sql.gz \
    s3://drone-backup-bucket/mysql/

# 古いバックアップの削除（30日以上）
find ${BACKUP_DIR} -name "full_*.sql.gz" -mtime +30 -delete

echo "Backup completed: full_${DATE}.sql.gz"
```

### 4.2 災害復旧計画

#### 4.2.1 RTO/RPO 目標

- **RTO（復旧時間目標）**: 4 時間
- **RPO（復旧ポイント目標）**: 1 時間

#### 4.2.2 復旧優先順位

1. **データベース復旧**（最優先）
2. **API サーバー復旧**
3. **フロントエンド復旧**
4. **監視システム復旧**

#### 4.2.3 復旧手順書

```
【緊急復旧手順】

1. 影響範囲確認（5分以内）
   - システム状況確認
   - ユーザー影響調査

2. 復旧方針決定（15分以内）
   - 障害原因特定
   - 復旧方法選択

3. データベース復旧（1時間以内）
   - 最新バックアップ確認
   - データ復元実行
   - 整合性チェック

4. アプリケーション復旧（2時間以内）
   - サーバー起動
   - 接続テスト
   - 機能確認

5. 全体テスト（3時間以内）
   - エンドツーエンドテスト
   - パフォーマンステスト

6. サービス再開（4時間以内）
   - ユーザー通知
   - 監視再開
```

---

## 5. 定期メンテナンス

### 5.1 メンテナンス計画

#### 5.1.1 定期メンテナンススケジュール

| メンテナンス種別       | 頻度   | 実施時間              | 所要時間 | 影響     |
| ---------------------- | ------ | --------------------- | -------- | -------- |
| **システム更新**       | 月次   | 第 2 土曜 02:00-06:00 | 4 時間   | 全面停止 |
| **セキュリティパッチ** | 緊急時 | 営業時間外            | 2 時間   | 部分停止 |
| **データベース最適化** | 週次   | 日曜 03:00-04:00      | 1 時間   | 性能低下 |
| **ログローテーション** | 日次   | 毎日 02:00            | 10 分    | 影響なし |

#### 5.1.2 メンテナンス作業内容

```sql
-- データベース週次メンテナンス
-- 1. 統計情報更新
ANALYZE TABLE stock_infos, stock_histories, operation_logs;

-- 2. インデックス最適化
OPTIMIZE TABLE stock_histories, operation_logs;

-- 3. 古いデータのアーカイブ
CALL sp_archive_old_data();

-- 4. パフォーマンス統計収集
SELECT table_name,
       round(((data_length + index_length) / 1024 / 1024), 2) as size_mb,
       table_rows
FROM information_schema.tables
WHERE table_schema = 'drone_inventory'
ORDER BY size_mb DESC;
```

### 5.2 パッチ適用手順

#### 5.2.1 アプリケーション更新手順

```bash
# 1. 事前バックアップ
./backup_before_update.sh

# 2. Blue-Green デプロイメント
# Green環境へ新バージョンデプロイ
docker-compose -f docker-compose.green.yml up -d

# 3. ヘルスチェック
curl -f http://green-server:8080/actuator/health

# 4. トラフィック切り替え
# ロードバランサー設定変更

# 5. Blue環境停止
docker-compose -f docker-compose.blue.yml down
```

---

## 6. セキュリティ運用

### 6.1 セキュリティ監視

#### 6.1.1 監視対象イベント

| イベント種別             | 監視内容                      | アラート条件         |
| ------------------------ | ----------------------------- | -------------------- |
| **認証失敗**             | ログイン試行失敗              | 5 回/5 分（同一 IP） |
| **不正アクセス**         | 認可されていない API 呼び出し | 10 回/時間           |
| **データ改ざん**         | 重要データの異常な変更        | 即座                 |
| **SQL インジェクション** | 不正 SQL パターン検知         | 即座                 |

#### 6.1.2 セキュリティログ分析

```bash
# 不審なアクセスパターン検知
grep "HTTP/1.1\" 40[13]" /var/log/nginx/access.log | \
awk '{print $1}' | sort | uniq -c | sort -nr | head -10

# 認証失敗の多いIP抽出
grep "Authentication failed" /var/log/drone-api/security.log | \
awk '{print $5}' | sort | uniq -c | sort -nr
```

### 6.2 脆弱性管理

#### 6.2.1 脆弱性スキャン

- **頻度**: 週次
- **対象**: OS、ミドルウェア、アプリケーション
- **ツール**: OpenVAS、OWASP ZAP

#### 6.2.2 パッチ管理プロセス

```
脆弱性情報収集
    ↓
影響度評価（24時間以内）
    ↓
パッチ計画策定（72時間以内）
    ↓
テスト環境検証
    ↓
本番環境適用
    ↓
適用結果確認
```

---

## 7. 容量管理

### 7.1 容量監視・予測

#### 7.1.1 ディスク使用量監視

| 対象             | 現在使用量  | 月間増加率 | 警告閾値 | 対策検討時期 |
| ---------------- | ----------- | ---------- | -------- | ------------ |
| **OS 領域**      | 15GB/50GB   | 1GB/月     | 40GB     | 2 年後       |
| **DB 領域**      | 25GB/100GB  | 5GB/月     | 80GB     | 11 ヶ月後    |
| **ログ領域**     | 10GB/20GB   | 2GB/月     | 15GB     | 2 ヶ月後     |
| **バックアップ** | 100GB/500GB | 20GB/月    | 400GB    | 15 ヶ月後    |

#### 7.1.2 容量予測計算

```sql
-- テーブル別容量増加傾向
SELECT
    table_name,
    ROUND((data_length + index_length) / 1024 / 1024, 2) as current_size_mb,
    table_rows,
    ROUND((data_length + index_length) / table_rows, 2) as avg_row_size
FROM information_schema.tables
WHERE table_schema = 'drone_inventory'
    AND table_rows > 0
ORDER BY current_size_mb DESC;
```

### 7.2 容量対策

#### 7.2.1 自動削除・アーカイブ

```bash
# 古いログファイルの自動削除
find /var/log/drone-api -name "*.log" -mtime +30 -delete

# バックアップの自動削除
find /backup -name "*.sql.gz" -mtime +30 -delete
```

#### 7.2.2 容量逼迫時の緊急対応

1. **即座の対応**（使用率 90%以上）

   - 不要ファイル削除
   - ログローテーション強制実行
   - 一時ディスク追加

2. **短期対応**（使用率 80%以上）
   - アーカイブ処理実行
   - パーティション削除
   - ディスク拡張計画

---

## 8. 性能管理

### 8.1 性能監視

#### 8.1.1 性能基準値

| 性能項目               | 目標値      | 警告値      | 測定方法         |
| ---------------------- | ----------- | ----------- | ---------------- |
| **画面表示速度**       | 3 秒以内    | 5 秒        | Web ブラウザ測定 |
| **API 応答時間**       | 2 秒以内    | 3 秒        | APM ツール       |
| **データベースクエリ** | 1 秒以内    | 2 秒        | スロークエリログ |
| **同時接続処理**       | 50 ユーザー | 40 ユーザー | 負荷テスト       |

#### 8.1.2 性能劣化の早期検知

```sql
-- スロークエリの分析
SELECT
    query_time,
    lock_time,
    sql_text
FROM mysql.slow_log
WHERE start_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)
ORDER BY query_time DESC
LIMIT 10;
```

### 8.2 性能チューニング

#### 8.2.1 定期性能レビュー

- **頻度**: 月次
- **対象**:
  - データベースクエリ最適化
  - インデックス効果確認
  - アプリケーション性能プロファイリング

#### 8.2.2 チューニング実施例

```sql
-- インデックス効果確認
EXPLAIN SELECT * FROM stock_infos
WHERE category_id = 1 AND current_stock < safety_stock;

-- クエリキャッシュ使用率確認
SHOW STATUS LIKE 'Qcache%';

-- バッファプール使用状況
SHOW STATUS LIKE 'Innodb_buffer_pool%';
```

---

## 9. 障害対応

### 9.1 障害分類・対応レベル

#### 9.1.1 障害レベル定義

| レベル      | 定義           | 影響範囲           | 対応時間     | 対応者     |
| ----------- | -------------- | ------------------ | ------------ | ---------- |
| **Level 1** | システム全停止 | 全ユーザー         | 即座         | 全チーム   |
| **Level 2** | 機能一部停止   | 一部ユーザー       | 30 分以内    | 関連チーム |
| **Level 3** | 性能劣化       | パフォーマンス低下 | 2 時間以内   | 担当チーム |
| **Level 4** | 軽微な問題     | 一部機能制限       | 1 営業日以内 | 担当者     |

#### 9.1.2 障害対応フロー

```
障害検知
    ↓
初動対応（5分以内）
    ↓
影響範囲確認（10分以内）
    ↓
対応方針決定（15分以内）
    ↓
復旧作業実施
    ↓
復旧確認・テスト
    ↓
ユーザー通知
    ↓
事後レビュー（24時間以内）
```

### 9.2 障害対応手順書

#### 9.2.1 システム停止時の対応

```bash
# 1. サービス状況確認
systemctl status drone-api
docker ps -a
netstat -tlnp | grep 8080

# 2. ログ確認
tail -f /var/log/drone-api/application.log
grep ERROR /var/log/drone-api/application.log | tail -20

# 3. データベース接続確認
mysql -u drone_app -p -e "SELECT 1"

# 4. サービス再起動
systemctl restart drone-api
docker-compose restart

# 5. 復旧確認
curl -f http://localhost:8080/actuator/health
```

### 9.3 復旧後の対応

#### 9.3.1 事後レビュー項目

- **障害原因分析**
- **対応時間の妥当性評価**
- **再発防止策の検討**
- **手順書の見直し**
- **監視設定の改善**

#### 9.3.2 改善アクション管理

```
障害報告書作成
    ↓
根本原因分析（RCA）
    ↓
改善計画策定
    ↓
改善実施・効果測定
    ↓
知見共有・手順書更新
```

---

## 10. 連絡体制・エスカレーション

### 10.1 緊急連絡先

#### 10.1.1 連絡先一覧

| 役割                   | 氏名     | 電話番号      | メール             | 対応時間     |
| ---------------------- | -------- | ------------- | ------------------ | ------------ |
| **システム管理者**     | 田中太郎 | 090-1234-5678 | tanaka@company.com | 24 時間      |
| **開発リーダー**       | 佐藤花子 | 090-2345-6789 | sato@company.com   | 平日 9-18 時 |
| **運用責任者**         | 鈴木次郎 | 090-3456-7890 | suzuki@company.com | 24 時間      |
| **セキュリティ責任者** | 山田三郎 | 090-4567-8901 | yamada@company.com | 24 時間      |

#### 10.1.2 エスカレーション手順

```
Level 4 障害
    ↓
担当者対応（1営業日）
    ↓ 解決できない場合
チームリーダー報告
    ↓
Level 3 障害
    ↓
関連チーム対応（2時間）
    ↓ 解決できない場合
部門管理者報告
    ↓
Level 2 障害
    ↓
複数チーム対応（30分）
    ↓ 解決できない場合
役員報告
    ↓
Level 1 障害
    ↓
全社対応（即座）
    ↓
経営陣報告
```

### 10.2 外部連絡先

#### 10.2.1 ベンダー・サポート連絡先

| 項目                     | 連絡先                   | サポート時間   | 契約レベル |
| ------------------------ | ------------------------ | -------------- | ---------- |
| **AWS サポート**         | support.aws.com          | 24 時間 365 日 | Business   |
| **MySQL サポート**       | mysql-support@oracle.com | 平日 9-17 時   | Standard   |
| **セキュリティベンダー** | security@vendor.com      | 24 時間 365 日 | Premium    |

---

## 11. 運用改善・継続的向上

### 11.1 運用メトリクス

#### 11.1.1 KPI（重要業績指標）

| KPI                      | 目標値   | 測定方法             | 評価頻度 |
| ------------------------ | -------- | -------------------- | -------- |
| **システム稼働率**       | 99.5%    | 稼働時間/全時間      | 月次     |
| **平均復旧時間（MTTR）** | 2 時間   | 障害発生から復旧まで | 四半期   |
| **平均故障間隔（MTBF）** | 720 時間 | 障害間の平均稼働時間 | 四半期   |
| **変更成功率**           | 95%      | 成功変更/全変更      | 月次     |

#### 11.1.2 運用効率指標

- **自動化率**: 手動作業の自動化割合
- **アラート精度**: 有効アラート/全アラート
- **ドキュメント更新率**: 手順書の最新性維持

### 11.2 継続的改善

#### 11.2.1 改善サイクル

```
Plan（計画）
    ↓
Do（実行）
    ↓
Check（評価）
    ↓
Act（改善）
    ↓
（繰り返し）
```

#### 11.2.2 改善活動例

- **月次運用レビュー**: 運用状況・課題の確認
- **四半期改善計画**: 大きな改善施策の計画・実行
- **年次運用監査**: 運用体制・手順の包括的見直し

---

## 12. 運用手順書・チェックリスト

### 12.1 日次運用チェックリスト

```
□ システム稼働状況確認
□ 前日発生アラート確認・対応
□ バックアップ実行状況確認
□ ディスク使用量確認
□ 重要プロセス稼働確認
□ ログ異常確認
□ 性能指標確認
□ セキュリティアラート確認
```

### 12.2 週次運用チェックリスト

```
□ データベース最適化実行
□ 古いログファイル削除
□ 容量使用状況レビュー
□ 性能トレンド分析
□ セキュリティスキャン実行
□ バックアップ復旧テスト
□ 監視設定見直し
□ 運用ドキュメント更新確認
```

### 12.3 月次運用チェックリスト

```
□ システム更新・パッチ適用
□ 容量計画見直し
□ 性能ベンチマーク実行
□ 障害対応レビュー
□ 運用KPI測定・評価
□ 改善計画進捗確認
□ DR（災害復旧）訓練実施
□ 運用体制見直し
```
